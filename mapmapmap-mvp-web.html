<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë§µë§µë§µ - ë§¤ìš´ë§› ì‹¤íŒ¨ ì—†ëŠ” ë§›ì§‘ ì§€ë„</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.css" />
  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&display=swap" rel="stylesheet">

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Noto Sans KR', sans-serif;
      background: #f5f5f5;
      min-height: 100vh;
    }

    /* ========== í—¤ë” ========== */
    .header {
      background: white;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      position: sticky;
      top: 0;
      z-index: 10000;
    }

    .header-inner {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .logo {
      font-size: 0px;
      font-weight: 900;
      color: #c5171e;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .user-info .nickname {
      font-weight: 600;
      color: #333;
    }

    .user-level-badge {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 700;
    }

    .level-0 {
      background: #f0f0f0;
      color: #666;
    }

    .level-1 {
      background: #e8f5e9;
      color: #2e7d32;
    }

    .level-2 {
      background: #fff3e0;
      color: #ef6c00;
    }

    .level-3 {
      background: #ffebee;
      color: #c62828;
    }

    .level-4 {
      background: #fce4ec;
      color: #ad1457;
    }

    .level-5 {
      background: #4a0000;
      color: #fff;
    }

    /* ========== ì˜¨ë³´ë”© ========== */
    #onboarding {
      min-height: calc(100vh - 80px);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px 20px;
      background: linear-gradient(135deg, #c5171e 0%, #ff6b35 100%);
    }

    .onboarding-container {
      background: white;
      border-radius: 24px;
      padding: 40px 30px;
      max-width: 450px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .onboarding-logo {
      text-align: center;
      margin-bottom: 30px;
    }

    .onboarding-logo h1 {
      font-size: 0px;
      font-weight: 900;
      color: #c5171e;
      margin-bottom: 8px;
    }

    .onboarding-logo p {
      color: #666;
      font-size: 14px;
    }

    .form-group {
      margin-bottom: 24px;
    }

    .form-group label {
      display: block;
      font-weight: 700;
      margin-bottom: 10px;
      color: #333;
      font-size: 15px;
    }

    .form-group input[type="text"] {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid #eee;
      border-radius: 12px;
      font-size: 16px;
      font-family: inherit;
      transition: border-color 0.2s;
    }

    .form-group input[type="text"]:focus {
      outline: none;
      border-color: #c5171e;
    }

    .level-options {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 350px;
      overflow-y: auto;
    }

    .level-option {
      display: flex;
      align-items: center;
      padding: 12px 14px;
      border: 2px solid #eee;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .level-option:hover {
      border-color: #ffccc0;
      background: #fff9f7;
    }

    .level-option.selected {
      border-color: #c5171e;
      background: #fff5f2;
    }

    .level-option input {
      display: none;
    }

    .level-badge {
      min-width: 55px;
      padding: 4px 8px;
      border-radius: 6px;
      font-weight: 700;
      font-size: 12px;
      text-align: center;
      margin-right: 12px;
      margin-bottom: 4px;
      display: inline-block;
    }

    .level-desc {
      font-size: 13px;
      color: #555;
      line-height: 1.4;
    }

    .level-desc strong {
      display: block;
      color: #333;
      margin-bottom: 2px;
    }

    .start-btn {
      width: 100%;
      padding: 16px;
      background: #c5171e;
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 18px;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.2s;
      font-family: inherit;
    }

    .start-btn:hover {
      background: #e03e00;
    }

    .start-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    /* ========== ë©”ì¸ ì»¨í…Œì´ë„ˆ ========== */
    #main-container {
      display: none;
    }

    .main-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    /* ìƒë‹¨ ì»¨íŠ¸ë¡¤ */
    .top-controls {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .filter-card {
      background: white;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
      flex: 1;
      min-width: 250px;
    }

    .filter-card h3 {
      font-size: 14px;
      color: #888;
      margin-bottom: 12px;
      font-weight: 600;
    }

    .toggle-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .toggle-label {
      font-size: 15px;
      color: #333;
      font-weight: 500;
    }

    .switch {
      position: relative;
      width: 50px;
      height: 28px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: 0.3s;
      border-radius: 28px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 22px;
      width: 22px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: 0.3s;
      border-radius: 50%;
    }

    input:checked+.slider {
      background-color: #c5171e;
    }

    input:checked+.slider:before {
      transform: translateX(22px);
    }

    /* ë²”ë¡€ */
    .legend {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: #555;
    }

    .legend-dot {
      width: 14px;
      height: 14px;
      border-radius: 50%;
    }

    .legend-dot.safe {
      background: #4CAF50;
    }

    .legend-dot.warning {
      background: #ff9800;
    }

    .legend-dot.danger {
      background: #f44336;
    }

    /* ì§€ë„ ì˜ì—­ */
    .map-section {
      background: white;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
      margin-bottom: 20px;
    }

    .map-section-header {
      padding: 20px 20px 10px 20px;
      border-bottom: 1px solid #eee;
    }

    .map-section h2 {
      padding: 0;
      font-size: 18px;
      border: none;
      margin-bottom: 12px;
    }

    #map {
      width: 100%;
      height: 500px;
    }

    /* ë§›ì§‘ ë¦¬ìŠ¤íŠ¸ */
    .restaurant-section {
      background: white;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
      margin-bottom: 20px;
    }

    .restaurant-section h2 {
      font-size: 18px;
      margin-bottom: 16px;
    }

    .restaurant-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 16px;
    }

    .restaurant-card {
      border: 1px solid #eee;
      border-radius: 12px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .restaurant-card:hover {
      border-color: #c5171e;
      box-shadow: 0 4px 12px rgba(255, 69, 0, 0.15);
    }

    .restaurant-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .restaurant-card h3 {
      font-size: 16px;
      color: #333;
    }

    .restaurant-card .avg-level {
      padding: 4px 10px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 700;
    }

    .restaurant-card .menus {
      font-size: 13px;
      color: #888;
      margin-bottom: 8px;
    }

    .restaurant-card .safety-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .safety-badge.safe {
      background: #e8f5e9;
      color: #2e7d32;
    }

    .safety-badge.warning {
      background: #fff3e0;
      color: #ef6c00;
    }

    .safety-badge.danger {
      background: #ffebee;
      color: #c62828;
    }

    /* í‘¸í„° */
    .footer {
      text-align: center;
      padding: 30px 20px;
      color: #999;
      font-size: 13px;
    }

    .footer a {
      color: #c5171e;
      text-decoration: none;
    }

    .reset-link {
      cursor: pointer;
      text-decoration: underline;
    }

    /* ========== ëª¨ë‹¬ (íŒì—… ëŒ€ì²´) ========== */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
      overflow-y: auto;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: white;
      border-radius: 20px;
      max-width: 500px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
    }

    .modal-header {
      padding: 20px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      background: white;
      border-radius: 20px 20px 0 0;
    }

    .modal-header h2 {
      font-size: 20px;
      color: #333;
    }

    .modal-close {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: none;
      background: #f5f5f5;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-close:hover {
      background: #eee;
    }

    .modal-body {
      padding: 20px;
    }

    .modal-avg-level {
      display: inline-block;
      padding: 6px 14px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 700;
      margin-bottom: 12px;
    }

    .modal-safety {
      display: inline-block;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
      margin-left: 8px;
      margin-bottom: 12px;
    }

    .stats-box {
      background: #fff5f2;
      border-radius: 12px;
      padding: 14px;
      margin-bottom: 20px;
      font-size: 14px;
    }

    .stats-box strong {
      color: #c5171e;
    }

    /* ë¦¬ë·° í¼ */
    .review-form {
      background: #f9f9f9;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
    }

    .review-form h4 {
      font-size: 15px;
      margin-bottom: 14px;
      color: #333;
    }

    .form-row {
      margin-bottom: 12px;
    }

    .form-row label {
      display: block;
      font-size: 13px;
      color: #666;
      margin-bottom: 6px;
    }

    .form-row select,
    .form-row input[type="text"] {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
    }

    .form-row select:focus,
    .form-row input[type="text"]:focus {
      outline: none;
      border-color: #c5171e;
    }

    .level-buttons {
      display: flex;
      gap: 6px;
    }

    .level-btn {
      flex: 1;
      padding: 12px 8px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background: white;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.2s;
      font-family: inherit;
    }

    .level-btn:hover {
      border-color: #c5171e;
    }

    .level-btn.selected {
      background: #c5171e;
      color: white;
      border-color: #c5171e;
    }

    .submit-btn {
      width: 100%;
      padding: 14px;
      background: #c5171e;
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      font-family: inherit;
    }

    .submit-btn:hover {
      background: #e03e00;
    }

    /* ë¦¬ë·° ë¦¬ìŠ¤íŠ¸ */
    .review-list h4 {
      font-size: 15px;
      margin-bottom: 14px;
      color: #333;
    }

    .review-item {
      padding: 14px 0;
      border-bottom: 1px solid #eee;
    }

    .review-item:last-child {
      border-bottom: none;
    }

    .review-meta {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }

    .review-nickname {
      font-weight: 600;
      font-size: 14px;
    }

    .review-user-level {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 4px;
      background: #eee;
    }

    .review-menu {
      font-size: 12px;
      color: #888;
    }

    .review-content {
      font-size: 14px;
      color: #333;
      line-height: 1.5;
    }

    .review-level {
      color: #c5171e;
      font-weight: 700;
    }

    .no-review {
      text-align: center;
      color: #999;
      font-size: 14px;
      padding: 30px 0;
    }

    /* ì»¤ìŠ¤í…€ ë§ˆì»¤ */
    .custom-marker {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      color: white;
      font-weight: 700;
      font-size: 16px;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
      border: 3px solid white;
    }

    /* ë°˜ì‘í˜• */
    @media (max-width: 768px) {
      .header-inner {
        padding: 12px 16px;
      }

      .logo {
        font-size: 0px;
      }

      .main-content {
        padding: 16px;
      }

      .top-controls {
        flex-direction: column;
      }

      #map {
        height: 400px;
      }

      .restaurant-list {
        grid-template-columns: 1fr;
      }

      .legend {
        flex-direction: column;
        gap: 10px;
      }
    }
  </style>
</head>

<body>
  <!-- í—¤ë” -->
  <header class="header">
    <div class="header-inner">
      <div class="logo"><img src="/img/logo.svg" alt="logo" width="40px"></div>
      <div class="user-info" id="header-user-info" style="display: none;">
        <span class="nickname" id="header-nickname"></span>
        <span class="user-level-badge" id="header-level"></span>
      </div>
    </div>
  </header>

  <!-- ì˜¨ë³´ë”© -->
  <div id="onboarding">
    <div class="onboarding-container">
      <div class="onboarding-logo">
        <h1><img src="/img/logo.svg" alt="logo" width="100px"></h1>
        <p>ë§¤ìš´ë§› ì‹¤íŒ¨ ì—†ëŠ” ë§›ì§‘ ì§€ë„</p>
      </div>

      <div class="form-group">
        <label>ë‹‰ë„¤ì„</label>
        <input type="text" id="nickname-input" placeholder="ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”" maxlength="10">
      </div>

      <div class="form-group">
        <label>ë‚˜ì˜ ë§µë ˆë²¨ì€?</label>
        <div class="level-options">
          <label class="level-option" data-level="0">
            <input type="radio" name="level" value="0">
            <span class="level-badge level-0">Lv.0</span>
            <span class="level-desc">
              <strong>ì „í˜€ ëª» ë¨¹ëŠ”ë‹¤</strong>
              ì§„ë¼ë©´ ìˆœí•œë§›ë„ ë§¤ì›€
            </span>
          </label>
          <label class="level-option" data-level="1">
            <input type="radio" name="level" value="1">
            <span class="level-badge level-1">Lv.1</span>
            <span class="level-desc">
              <strong>ê±°ì˜ ëª» ë¨¹ëŠ”ë‹¤</strong>
              ì‹ ë¼ë©´ ì •ë„ ê°€ëŠ¥
            </span>
          </label>
          <label class="level-option" data-level="2">
            <input type="radio" name="level" value="2">
            <span class="level-badge level-2">Lv.2 ğŸŒ¶ï¸</span>
            <span class="level-desc">
              <strong>ì˜ ëª» ë¨¹ëŠ” í¸ì´ë‹¤</strong>
              ì—´ë¼ë©´ ì •ë„ ê°€ëŠ¥
            </span>
          </label>
          <label class="level-option" data-level="3">
            <input type="radio" name="level" value="3">
            <span class="level-badge level-3">Lv.3 ğŸŒ¶ï¸ğŸŒ¶ï¸</span>
            <span class="level-desc">
              <strong>ë³´í†µì´ë‹¤</strong>
              ë¶ˆë‹­ë³¶ìŒë©´, ì—½ë–¡ ì˜¤ë¦¬ì§€ë„ ê°€ëŠ¥
            </span>
          </label>
          <label class="level-option" data-level="4">
            <input type="radio" name="level" value="4">
            <span class="level-badge level-4">Lv.4 ğŸ”¥ğŸ”¥</span>
            <span class="level-desc">
              <strong>ì˜ ë¨¹ëŠ” í¸ì´ë‹¤</strong>
              ì—½ë–¡ ë§¤ìš´ë§› ê°€ëŠ¥
            </span>
          </label>
          <label class="level-option" data-level="5">
            <input type="radio" name="level" value="5">
            <span class="level-badge level-5">Lv.5 ğŸ”¥ğŸ”¥ğŸ”¥</span>
            <span class="level-desc">
              <strong>ì•„ì£¼ ì˜ ë¨¹ëŠ”ë‹¤</strong>
              í•µë¶ˆë‹­, ë””ì§„ë‹¤ëˆê¹ŒìŠ¤ ë„ì „ ê°€ëŠ¥
            </span>
          </label>
        </div>
      </div>

      <button class="start-btn" id="start-btn" disabled>ì‹œì‘í•˜ê¸°</button>
    </div>
  </div>

  <!-- ë©”ì¸ ì»¨í…Œì´ë„ˆ -->
  <div id="main-container">
    <div class="main-content">
      <!-- ìƒë‹¨ ì»¨íŠ¸ë¡¤ -->
      <div class="top-controls">
        <!-- <div class="filter-card">
          <h3>ğŸ›¡ï¸ ì•ˆì „ í•„í„°</h3>
          <div class="toggle-row">
            <span class="toggle-label">ë‚´ ë ˆë²¨ ì´í•˜ë§Œ ë³´ê¸°</span>
            <label class="switch">
              <input type="checkbox" id="safety-filter">
              <span class="slider"></span>
            </label>
          </div>
        </div> -->

        <div class="filter-card">
          <h3>ğŸ“ ë‚´ ê¸°ì¤€ìœ¼ë¡œ ë‹¤ì‹œ ì“°ëŠ” ë§µë ˆë²¨</h3>
          <div class="legend">
            <div class="legend-item">
              <span class="legend-dot safe"></span>
              <span>Safe - ë§›ìˆê²Œ ë¨¹ì„ ìˆ˜ ìˆì–´ìš”</span>
            </div>
            <div class="legend-item">
              <span class="legend-dot warning"></span>
              <span>Warning - ì¡°ê¸ˆ ë§¤ìš¸ ìˆ˜ ìˆì–´ìš”</span>
            </div>
            <div class="legend-item">
              <span class="legend-dot danger"></span>
              <span>Danger - ë„ì „ì´ í•„ìš”í•´ìš”</span>
            </div>
          </div>
        </div>
      </div>

      <!-- ì§€ë„ -->
      <div class="map-section">
        <div class="map-section-header">
          <h2>ğŸ—ºï¸ ë§¤ìš´ë§›ì§‘ ì§€ë„</h2>
          <div class="toggle-row">
            <span class="toggle-label">ë‚´ ë ˆë²¨ ì´í•˜ë§Œ ë³´ê¸°</span>
            <label class="switch">
              <input type="checkbox" id="safety-filter">
              <span class="slider"></span>
            </label>
          </div>
        </div>
        <div id="map"></div>
      </div>

      <!-- ë§›ì§‘ ë¦¬ìŠ¤íŠ¸ -->
      <div class="restaurant-section">
        <h2>ğŸœ ë§›ì§‘ ë¦¬ìŠ¤íŠ¸</h2>
        <div class="restaurant-list" id="restaurant-list"></div>
      </div>
    </div>

    <!-- í‘¸í„° -->
    <div class="footer">
      <p>ğŸ”¥ ë§µë§µë§µ - ë§¤ìš´ë§› ì‹¤íŒ¨ ì—†ëŠ” ë§›ì§‘ ì§€ë„</p>
      <p style="margin-top: 8px;">
        <span class="reset-link" onclick="resetData()">ì²˜ìŒë¶€í„° ë‹¤ì‹œí•˜ê¸°</span>
      </p>
    </div>
  </div>

  <!-- ëª¨ë‹¬ -->
  <div class="modal-overlay" id="modal-overlay">
    <div class="modal" id="modal">
      <div class="modal-header">
        <h2 id="modal-title"></h2>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      <div class="modal-body" id="modal-body"></div>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.js"></script>

  <script>
    // ========== ë°ì´í„° ==========
    const restaurants = [
      {
        id: 1,
        name: 'ì§„ë¯¸í‰ì–‘ëƒ‰ë©´',
        lat: 37.5161,
        lng: 127.036,
        avgLevel: 1,
        menus: ['í‰ì–‘ëƒ‰ë©´', 'ë¹„ë¹”ëƒ‰ë©´', 'ì œìœ¡']
      },
      {
        id: 2,
        name: 'í™ì´ˆë¶ˆë‹­ ì‹ ì´Œ',
        lat: 37.558251,
        lng: 126.935204,
        avgLevel: 3,
        menus: ['ë§ˆìš”ë¶ˆë‹­', 'ìˆ¯ë‹­', 'ë¶ˆë°¥']
      },
      {
        id: 3,
        name: 'ì˜¨ì •ëˆê¹ŒìŠ¤',
        lat: 37.53,
        lng: 126.98,
        avgLevel: 5,
        menus: ['ë””ì§„ë‹¤ëˆê¹ŒìŠ¤', 'ë§¤ìš´ëˆê¹ŒìŠ¤', 'ì¹˜ì¦ˆëˆê¹ŒìŠ¤']
      }
    ];

    const defaultReviews = {
      1: [
        { nickname: 'ëƒ‰ë©´ì¢‹ì•„', userLevel: 2, menu: 'í‰ì–‘ëƒ‰ë©´', level: 1, text: 'ì „í˜€ ì•ˆ ë§¤ì›Œìš”. ë§›ìˆì–´ìš”!' }
      ],
      2: [
        { nickname: 'ë§µë¶€ì‹¬', userLevel: 5, menu: 'ë§ˆìš”ë¶ˆë‹­', level: 3, text: 'ì ë‹¹í•˜ê²Œ ë§µë„¤ìš”.' }
      ],
      3: [
        { nickname: 'ë„ì „ì™•', userLevel: 4, menu: 'ë””ì§„ë‹¤ëˆê¹ŒìŠ¤', level: 5, text: 'ì§„ì§œ ë§¤ì›Œìš”... ê°ì˜¤í•˜ì„¸ìš”' }
      ]
    };

    // ========== ìƒíƒœ ==========
    let currentUser = null;
    let reviews = {};
    let map = null;
    let markers = [];
    let selectedLevels = {};

    // ========== localStorage ==========
    function loadData() {
      const savedUser = localStorage.getItem('mapmapmap_user');
      const savedReviews = localStorage.getItem('mapmapmap_reviews');

      if (savedUser) currentUser = JSON.parse(savedUser);
      reviews = savedReviews ? JSON.parse(savedReviews) : JSON.parse(JSON.stringify(defaultReviews));
    }

    function saveData() {
      localStorage.setItem('mapmapmap_user', JSON.stringify(currentUser));
      localStorage.setItem('mapmapmap_reviews', JSON.stringify(reviews));
    }

    function resetData() {
      if (confirm('ëª¨ë“  ë°ì´í„°ê°€ ì´ˆê¸°í™”ë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        localStorage.removeItem('mapmapmap_user');
        localStorage.removeItem('mapmapmap_reviews');
        location.reload();
      }
    }

    // ========== ì˜¨ë³´ë”© ==========
    function initOnboarding() {
      const nicknameInput = document.getElementById('nickname-input');
      const levelOptions = document.querySelectorAll('.level-option');
      const startBtn = document.getElementById('start-btn');

      let selectedLevel = null;

      levelOptions.forEach(option => {
        option.addEventListener('click', () => {
          levelOptions.forEach(o => o.classList.remove('selected'));
          option.classList.add('selected');
          option.querySelector('input').checked = true;
          selectedLevel = parseInt(option.dataset.level);
          checkFormValid();
        });
      });

      nicknameInput.addEventListener('input', checkFormValid);

      function checkFormValid() {
        const nickname = nicknameInput.value.trim();
        startBtn.disabled = !(nickname.length > 0 && selectedLevel !== null);
      }

      startBtn.addEventListener('click', () => {
        currentUser = {
          nickname: nicknameInput.value.trim(),
          level: selectedLevel
        };
        saveData();
        showMain();
      });
    }

    // ========== ë©”ì¸ í™”ë©´ ==========
    function showMain() {
      document.getElementById('onboarding').style.display = 'none';
      document.getElementById('main-container').style.display = 'block';

      // í—¤ë” ìœ ì € ì •ë³´
      document.getElementById('header-user-info').style.display = 'flex';
      document.getElementById('header-nickname').textContent = currentUser.nickname;
      const levelBadge = document.getElementById('header-level');
      levelBadge.textContent = `Lv.${currentUser.level}`;
      levelBadge.className = `user-level-badge level-${currentUser.level}`;

      initMap();
      renderRestaurantList();

      document.getElementById('safety-filter').addEventListener('change', () => {
        updateMarkers();
        renderRestaurantList();
      });
    }

    // ========== ì§€ë„ ==========
    function initMap() {
      map = L.map('map').setView([37.54, 126.98], 12);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap'
      }).addTo(map);

      updateMarkers();
    }

    function updateMarkers() {
      const safetyFilter = document.getElementById('safety-filter').checked;

      markers.forEach(m => map.removeLayer(m));
      markers = [];

      restaurants.forEach(restaurant => {
        const status = getStatus(restaurant.avgLevel);
        const isHidden = safetyFilter && restaurant.avgLevel > currentUser.level;

        if (isHidden) return;

        let color;
        if (status === 'safe') color = '#4CAF50';
        else if (status === 'warning') color = '#ff9800';
        else color = '#f44336';

        const markerIcon = L.divIcon({
          className: '',
          html: `<div class="custom-marker" style="background: ${color};">${restaurant.avgLevel}</div>`,
          iconSize: [40, 40],
          iconAnchor: [20, 20]
        });

        const marker = L.marker([restaurant.lat, restaurant.lng], { icon: markerIcon })
          .addTo(map)
          .on('click', () => openModal(restaurant));

        marker.bindTooltip(`${restaurant.name} (í‰ê·  Lv.${restaurant.avgLevel})`, {
          direction: 'top',
          offset: [0, -20]
        });

        markers.push(marker);
      });
    }

    function getStatus(avgLevel) {
      if (avgLevel <= currentUser.level) return 'safe';
      if (avgLevel === currentUser.level + 1) return 'warning';
      return 'danger';
    }

    // ========== ë§›ì§‘ ë¦¬ìŠ¤íŠ¸ ==========
    function renderRestaurantList() {
      const safetyFilter = document.getElementById('safety-filter').checked;
      const listEl = document.getElementById('restaurant-list');

      const filteredRestaurants = safetyFilter
        ? restaurants.filter(r => r.avgLevel <= currentUser.level)
        : restaurants;

      listEl.innerHTML = filteredRestaurants.map(r => {
        const status = getStatus(r.avgLevel);
        let statusText, statusClass;
        if (status === 'safe') { statusText = 'âœ… Safe'; statusClass = 'safe'; }
        else if (status === 'warning') { statusText = 'âš ï¸ Warning'; statusClass = 'warning'; }
        else { statusText = 'ğŸ”¥ Danger'; statusClass = 'danger'; }

        return `
                    <div class="restaurant-card" onclick="openModal(restaurants.find(x => x.id === ${r.id}))">
                        <div class="restaurant-card-header">
                            <h3>${r.name}</h3>
                            <span class="avg-level level-${r.avgLevel}">í‰ê·  Lv.${r.avgLevel}</span>
                        </div>
                        <div class="menus">${r.menus.join(' Â· ')}</div>
                        <span class="safety-badge ${statusClass}">${statusText}</span>
                    </div>
                `;
      }).join('');
    }

    // ========== ëª¨ë‹¬ ==========
    function openModal(restaurant) {
      const status = getStatus(restaurant.avgLevel);
      const restaurantReviews = reviews[restaurant.id] || [];
      const stats = calculateStats(restaurant.id);

      let statusText, statusClass;
      if (status === 'safe') { statusText = 'âœ… Safe - ë§›ìˆê²Œ ë¨¹ì„ ìˆ˜ ìˆì–´ìš”'; statusClass = 'safe'; }
      else if (status === 'warning') { statusText = 'âš ï¸ Warning - ì¡°ê¸ˆ ë§¤ìš¸ ìˆ˜ ìˆì–´ìš”'; statusClass = 'warning'; }
      else { statusText = 'ğŸ”¥ Danger - ë„ì „ì´ í•„ìš”í•´ìš”!'; statusClass = 'danger'; }

      document.getElementById('modal-title').textContent = restaurant.name;
      document.getElementById('modal-body').innerHTML = `
                <span class="modal-avg-level level-${restaurant.avgLevel}">í‰ê·  Lv.${restaurant.avgLevel}</span>
                <span class="modal-safety safety-badge ${statusClass}">${statusText}</span>
                
                ${stats.hasStats ? `
                <div class="stats-box">
                    ğŸ“Š ${stats.isSameLevelStats
            ? `<strong>Lv.${currentUser.level} ì‚¬ìš©ì ${stats.sameLevel}ëª…</strong> ì¤‘ <strong>${stats.percentage}%</strong>ê°€ Lv.${stats.mostCommonLevel}ë¡œ í‰ê°€í–ˆì–´ìš”`
            : `<strong>ì „ì²´ ë¦¬ë·°ì–´ ${stats.targetCount}ëª…</strong> ì¤‘ <strong>${stats.percentage}%</strong>ê°€ Lv.${stats.mostCommonLevel}ë¡œ í‰ê°€í–ˆì–´ìš”`
          }
                </div>
                ` : ''}
                
                <div class="review-form">
                    <h4>âœï¸ ë¦¬ë·° ë‚¨ê¸°ê¸°</h4>
                    <div class="form-row">
                        <label>ë©”ë‰´ ì„ íƒ</label>
                        <select id="modal-menu">
                            <option value="">ë©”ë‰´ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                            ${restaurant.menus.map(m => `<option value="${m}">${m}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-row">
                        <label>ë§µê¸° í‰ê°€</label>
                        <div class="level-buttons" id="modal-level-buttons">
                            ${[0, 1, 2, 3, 4, 5].map(l => `
                                <button class="level-btn" data-level="${l}" onclick="selectModalLevel(${l})">${l}</button>
                            `).join('')}
                        </div>
                    </div>
                    <div class="form-row">
                        <label>í•œì¤„í‰</label>
                        <input type="text" id="modal-text" placeholder="ë§›ì€ ì–´ë• ë‚˜ìš”?">
                    </div>
                    <button class="submit-btn" onclick="submitModalReview(${restaurant.id})">ë¦¬ë·° ë“±ë¡</button>
                </div>
                
                <div class="review-list">
                    <h4>ğŸ’¬ ë¦¬ë·° (${restaurantReviews.length})</h4>
                    ${restaurantReviews.length > 0 ?
          restaurantReviews.map(r => `
                            <div class="review-item">
                                <div class="review-meta">
                                    <span class="review-nickname">${r.nickname}</span>
                                    <span class="review-user-level">Lv.${r.userLevel}</span>
                                    <span class="review-menu">| ${r.menu}</span>
                                </div>
                                <div class="review-content">
                                    <span class="review-level">[í‰ê°€: Lv.${r.level}]</span> ${r.text}
                                </div>
                            </div>
                        `).join('')
          : '<div class="no-review">ì•„ì§ ë¦¬ë·°ê°€ ì—†ì–´ìš”. ì²« ë¦¬ë·°ë¥¼ ë‚¨ê²¨ë³´ì„¸ìš”!</div>'
        }
                </div>
            `;

      selectedLevels.modal = undefined;
      document.getElementById('modal-overlay').classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closeModal() {
      document.getElementById('modal-overlay').classList.remove('active');
      document.body.style.overflow = '';
    }

    document.getElementById('modal-overlay').addEventListener('click', (e) => {
      if (e.target === document.getElementById('modal-overlay')) closeModal();
    });

    function selectModalLevel(level) {
      selectedLevels.modal = level;
      document.querySelectorAll('#modal-level-buttons .level-btn').forEach(btn => {
        btn.classList.toggle('selected', parseInt(btn.dataset.level) === level);
      });
    }

    function submitModalReview(restaurantId) {
      const menu = document.getElementById('modal-menu').value;
      const level = selectedLevels.modal;
      const text = document.getElementById('modal-text').value.trim();

      if (!menu) { alert('ë©”ë‰´ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!'); return; }
      if (level === undefined) { alert('ë§µê¸° ë ˆë²¨ì„ ì„ íƒí•´ì£¼ì„¸ìš”!'); return; }
      if (!text) { alert('ë¦¬ë·° ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!'); return; }

      if (!reviews[restaurantId]) reviews[restaurantId] = [];

      reviews[restaurantId].unshift({
        nickname: currentUser.nickname,
        userLevel: currentUser.level,
        menu, level, text
      });

      saveData();
      alert('ë¦¬ë·°ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ”¥');

      const restaurant = restaurants.find(r => r.id === restaurantId);
      openModal(restaurant); // ìƒˆë¡œê³ ì¹¨
    }

    function calculateStats(restaurantId) {
      const restaurantReviews = reviews[restaurantId] || [];
      const total = restaurantReviews.length;

      if (total === 0) return { total: 0, hasStats: false };

      // ê°™ì€ ë ˆë²¨ ì‚¬ìš©ì ë¦¬ë·°
      const sameLevelReviews = restaurantReviews.filter(r => r.userLevel === currentUser.level);
      const sameLevel = sameLevelReviews.length;

      let targetReviews, isSameLevelStats;

      if (sameLevel > 0) {
        // ê°™ì€ ë ˆë²¨ ì‚¬ìš©ìê°€ ìˆìœ¼ë©´ ê·¸ë“¤ì˜ í†µê³„
        targetReviews = sameLevelReviews;
        isSameLevelStats = true;
      } else {
        // ì—†ìœ¼ë©´ ì „ì²´ í†µê³„
        targetReviews = restaurantReviews;
        isSameLevelStats = false;
      }

      // ê°€ì¥ ë§ì´ í‰ê°€ëœ ë ˆë²¨ ì°¾ê¸°
      const levelCounts = {};
      targetReviews.forEach(r => {
        levelCounts[r.level] = (levelCounts[r.level] || 0) + 1;
      });

      let mostCommonLevel = 0;
      let maxCount = 0;
      for (const [level, count] of Object.entries(levelCounts)) {
        if (count > maxCount) {
          maxCount = count;
          mostCommonLevel = parseInt(level);
        }
      }

      const percentage = Math.round((maxCount / targetReviews.length) * 100);

      return {
        total,
        sameLevel,
        percentage,
        isSameLevelStats,
        mostCommonLevel,
        targetCount: targetReviews.length,
        hasStats: true
      };
    }

    // ========== ì´ˆê¸°í™” ==========
    document.addEventListener('DOMContentLoaded', () => {
      loadData();
      currentUser ? showMain() : initOnboarding();
    });
  </script>
</body>

</html>