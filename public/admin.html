<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë§µë§µë§µ Admin - ì œë³´ ê´€ë¦¬</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Noto Sans KR', sans-serif; background: #f5f5f5; min-height: 100vh; }

    .header { background: #1a1a2e; color: white; padding: 16px 24px; display: flex; justify-content: space-between; align-items: center; }
    .header h1 { font-size: 20px; }
    .header .logo { color: #ff6b6b; font-weight: 700; }

    .container { max-width: 1400px; margin: 0 auto; padding: 24px; }

    .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; }
    .stat-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
    .stat-card .label { font-size: 13px; color: #888; margin-bottom: 8px; }
    .stat-card .value { font-size: 28px; font-weight: 700; color: #333; }
    .stat-card .value.pending { color: #ff9800; }
    .stat-card .value.approved { color: #4CAF50; }
    .stat-card .value.rejected { color: #f44336; }

    .tabs { display: flex; gap: 8px; margin-bottom: 20px; }
    .tab { padding: 10px 20px; background: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; color: #666; transition: all 0.2s; }
    .tab.active { background: #c5171e; color: white; }
    .tab:hover:not(.active) { background: #f0f0f0; }
    .tab .count { background: rgba(0,0,0,0.1); padding: 2px 8px; border-radius: 10px; margin-left: 6px; font-size: 12px; }
    .tab.active .count { background: rgba(255,255,255,0.2); }

    .review-list { display: flex; flex-direction: column; gap: 16px; }
    .review-card { background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); overflow: hidden; }
    .review-card-header { padding: 16px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
    .review-card-header .info { display: flex; align-items: center; gap: 12px; }
    .review-card-header .nickname { font-weight: 600; color: #333; }
    .review-card-header .level-badge { padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600; background: #ffebee; color: #c62828; }
    .review-card-header .date { font-size: 13px; color: #888; }
    .status-badge { padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
    .status-badge.pending { background: #fff3e0; color: #ef6c00; }
    .status-badge.approved { background: #e8f5e9; color: #2e7d32; }
    .status-badge.rejected { background: #ffebee; color: #c62828; }

    .review-card-body { padding: 20px; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
    @media (max-width: 900px) { .review-card-body { grid-template-columns: 1fr; } }

    .image-section { display: flex; flex-direction: column; gap: 12px; }
    .image-box { border: 1px solid #eee; border-radius: 8px; overflow: hidden; }
    .image-box .label { padding: 8px 12px; background: #f8f9fa; font-size: 12px; font-weight: 600; color: #666; }
    .image-box img { width: 100%; height: 200px; object-fit: cover; cursor: pointer; }
    .image-box img:hover { opacity: 0.9; }

    .info-section h3 { font-size: 14px; color: #888; margin-bottom: 12px; }
    .info-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f0f0f0; }
    .info-row:last-child { border-bottom: none; }
    .info-row .label { color: #666; font-size: 13px; }
    .info-row .value { font-weight: 600; color: #333; font-size: 14px; }
    .info-row .value.level { color: #c5171e; }
    .comment-box { margin-top: 12px; padding: 12px; background: #f8f9fa; border-radius: 8px; font-size: 14px; color: #555; }

    .action-section { display: flex; flex-direction: column; gap: 12px; }
    .action-section h3 { font-size: 14px; color: #888; margin-bottom: 4px; }
    .memo-input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; font-family: inherit; resize: vertical; min-height: 80px; }
    .memo-input:focus { outline: none; border-color: #c5171e; }
    .reject-select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; font-family: inherit; }
    .action-buttons { display: flex; gap: 12px; margin-top: auto; }
    .btn { flex: 1; padding: 14px; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
    .btn-reject { background: #ffebee; color: #c62828; }
    .btn-reject:hover { background: #ffcdd2; }
    .btn-approve { background: #c5171e; color: white; }
    .btn-approve:hover { background: #a01118; }

    .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center; }
    .modal-overlay.active { display: flex; }
    .modal-overlay img { max-width: 90%; max-height: 90%; object-fit: contain; border-radius: 8px; }
    .modal-close { position: absolute; top: 20px; right: 20px; background: white; border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 24px; cursor: pointer; }

    .empty-state { text-align: center; padding: 60px 20px; color: #888; }
    .empty-state .icon { font-size: 48px; margin-bottom: 16px; }
  </style>
</head>
<body>
  <header class="header">
    <h1><span class="logo">ğŸŒ¶ï¸ ë§µë§µë§µ</span> Admin</h1>
    <span id="admin-info">ë¡œë”© ì¤‘...</span>
  </header>

  <div class="container">
    <div class="stats-row">
      <div class="stat-card">
        <div class="label">ì´ íšŒì› ìˆ˜</div>
        <div class="value">1,234</div>
      </div>
      <div class="stat-card">
        <div class="label">ìŠ¹ì¸ ëŒ€ê¸°</div>
        <div class="value pending" id="pending-count">5</div>
      </div>
      <div class="stat-card">
        <div class="label">ì˜¤ëŠ˜ ìŠ¹ì¸</div>
        <div class="value approved">12</div>
      </div>
      <div class="stat-card">
        <div class="label">ì˜¤ëŠ˜ ë°˜ë ¤</div>
        <div class="value rejected">2</div>
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" data-status="pending">ëŒ€ê¸° ì¤‘ <span class="count" id="tab-pending-count">5</span></button>
      <button class="tab" data-status="approved">ìŠ¹ì¸ë¨ <span class="count">48</span></button>
      <button class="tab" data-status="rejected">ë°˜ë ¤ë¨ <span class="count">7</span></button>
    </div>

    <div class="review-list" id="review-list"></div>
  </div>

  <div class="modal-overlay" id="image-modal" onclick="closeImageModal()">
    <button class="modal-close" onclick="closeImageModal()">Ã—</button>
    <img id="modal-image" src="" alt="">
  </div>

  <!-- API Client -->
  <script src="/js/api.js"></script>

  <script>
    // ìƒíƒœ
    let allReviews = [];
    let stats = { users: 0, reviews: { pending: 0, approved: 0, rejected: 0 } };
    let currentTab = 'pending';

    const rejectReasons = [
      'ì˜ìˆ˜ì¦ ì‹ë³„ ë¶ˆê°€',
      'ìŒì‹ ì‚¬ì§„ ë¶ˆëŸ‰',
      'ê°€ê²Œ/ë©”ë‰´ ë¶ˆì¼ì¹˜',
      'ì¤‘ë³µ ì œë³´',
      'ë¶€ì ì ˆí•œ ë‚´ìš©',
      'ê¸°íƒ€'
    ];

    // ì´ˆê¸°í™”
    async function init() {
      // ê´€ë¦¬ì ê¶Œí•œ í™•ì¸
      try {
        const result = await API.auth.me();
        if (!result.user || !result.user.is_admin) {
          alert('ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
          location.href = '/';
          return;
        }
        document.getElementById('admin-info').textContent = `${result.user.nickname}ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤`;
      } catch (error) {
        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        location.href = '/';
        return;
      }

      // ë°ì´í„° ë¡œë“œ
      await loadData();
    }

    async function loadData() {
      try {
        const statusFilter = currentTab === 'all' ? '' : currentTab;
        const result = await API.admin.getReviews(statusFilter);
        allReviews = result.reviews || [];
        stats.reviews = result.stats || { pending: 0, approved: 0, rejected: 0 };

        // í†µê³„ ë¡œë“œ
        const statsResult = await API.admin.getStats();
        stats = statsResult.stats || stats;

        updateUI();
      } catch (error) {
        console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
        showToast('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨', 'error');
      }
    }

    function updateUI() {
      // í†µê³„ ì—…ë°ì´íŠ¸
      document.getElementById('pending-count').textContent = stats.reviews?.pending || 0;
      document.getElementById('tab-pending-count').textContent = stats.reviews?.pending || 0;
      document.querySelector('.stat-card:nth-child(1) .value').textContent = stats.users || 0;
      document.querySelector('.stat-card:nth-child(3) .value').textContent = stats.reviews?.approved || 0;
      document.querySelector('.stat-card:nth-child(4) .value').textContent = stats.reviews?.rejected || 0;

      // íƒ­ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
      document.querySelectorAll('.tab')[1].querySelector('.count').textContent = stats.reviews?.approved || 0;
      document.querySelectorAll('.tab')[2].querySelector('.count').textContent = stats.reviews?.rejected || 0;

      renderReviews();
    }

    function renderReviews() {
      const listEl = document.getElementById('review-list');
      const reviews = allReviews.filter(r => r.status === currentTab);

      if (reviews.length === 0) {
        listEl.innerHTML = `
          <div class="empty-state">
            <div class="icon">${currentTab === 'pending' ? 'âœ…' : currentTab === 'approved' ? 'ğŸ“‹' : 'ğŸ“'}</div>
            <p>${currentTab === 'pending' ? 'ì²˜ë¦¬í•  ì œë³´ê°€ ì—†ìŠµë‹ˆë‹¤' : 'ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤'}</p>
          </div>
        `;
        return;
      }

      listEl.innerHTML = reviews.map(r => {
        const createdAt = new Date(r.created_at).toLocaleString('ko-KR');
        const foodImage = r.food_image_url ? `/uploads/${r.food_image_url}` : 'https://via.placeholder.com/400x200?text=No+Image';
        const receiptImage = r.receipt_image_url ? `/uploads/${r.receipt_image_url}` : 'https://via.placeholder.com/400x200?text=No+Image';

        return `
          <div class="review-card" id="review-${r.id}">
            <div class="review-card-header">
              <div class="info">
                <span class="nickname">${r.user_nickname || 'ìµëª…'}</span>
                <span class="level-badge">Lv.${r.user_spicy_level ?? '?'}</span>
                <span class="date">${createdAt}</span>
              </div>
              <span class="status-badge ${r.status}">${r.status === 'pending' ? 'ê²€ìˆ˜ ëŒ€ê¸°' : r.status === 'approved' ? 'ìŠ¹ì¸ë¨' : 'ë°˜ë ¤ë¨'}</span>
            </div>
            <div class="review-card-body">
              <div class="image-section">
                <div class="image-box">
                  <div class="label">ğŸ“· ìŒì‹ ì‚¬ì§„</div>
                  <img src="${foodImage}" alt="ìŒì‹" onclick="openImageModal('${foodImage}')" onerror="this.src='https://via.placeholder.com/400x200?text=No+Image'">
                </div>
                <div class="image-box">
                  <div class="label">ğŸ§¾ ì˜ìˆ˜ì¦</div>
                  <img src="${receiptImage}" alt="ì˜ìˆ˜ì¦" onclick="openImageModal('${receiptImage}')" onerror="this.src='https://via.placeholder.com/400x200?text=No+Image'">
                </div>
              </div>
              <div class="info-section">
                <h3>ğŸ“‹ ì œë³´ ì •ë³´</h3>
                <div class="info-row">
                  <span class="label">ê°€ê²Œ</span>
                  <span class="value">${r.restaurant_name || 'ì•Œ ìˆ˜ ì—†ìŒ'}</span>
                </div>
                <div class="info-row">
                  <span class="label">ì£¼ì†Œ</span>
                  <span class="value" style="font-size: 12px;">${r.restaurant_address || ''}</span>
                </div>
                <div class="info-row">
                  <span class="label">ë©”ë‰´</span>
                  <span class="value">${r.menu_name || ''}</span>
                </div>
                <div class="info-row">
                  <span class="label">ë§µê¸° í‰ê°€</span>
                  <span class="value level">Lv.${r.spicy_level}</span>
                </div>
                ${r.content ? `<div class="comment-box">"${r.content}"</div>` : ''}
              </div>
              <div class="action-section">
                ${r.status === 'pending' ? `
                  <div>
                    <h3>âŒ ë°˜ë ¤ ì‚¬ìœ  (ë°˜ë ¤ ì‹œ)</h3>
                    <select class="reject-select" id="reject-${r.id}">
                      <option value="">ì‚¬ìœ  ì„ íƒ</option>
                      ${rejectReasons.map(reason => `<option value="${reason}">${reason}</option>`).join('')}
                    </select>
                  </div>
                  <div class="action-buttons">
                    <button class="btn btn-reject" onclick="rejectReview('${r.id}')">ë°˜ë ¤</button>
                    <button class="btn btn-approve" onclick="approveReview('${r.id}')">ìŠ¹ì¸ (+500P)</button>
                  </div>
                ` : r.status === 'approved' ? `
                  <div style="text-align: center; color: #4CAF50; padding: 20px;">
                    <div style="font-size: 32px; margin-bottom: 8px;">âœ…</div>
                    <div style="font-weight: 600;">ìŠ¹ì¸ ì™„ë£Œ</div>
                    <div style="font-size: 13px; color: #888; margin-top: 4px;">+${r.points_given || 500}P ì§€ê¸‰ë¨</div>
                  </div>
                ` : `
                  <div style="text-align: center; color: #f44336; padding: 20px;">
                    <div style="font-size: 32px; margin-bottom: 8px;">âŒ</div>
                    <div style="font-weight: 600;">ë°˜ë ¤ë¨</div>
                    <div style="font-size: 13px; color: #888; margin-top: 4px;">${r.reject_reason || 'ì‚¬ìœ  ì—†ìŒ'}</div>
                  </div>
                `}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    async function approveReview(id) {
      if (!confirm('ì´ ì œë³´ë¥¼ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâ€¢ ì§€ë„ì— ë°ì´í„°ê°€ ë…¸ì¶œë©ë‹ˆë‹¤\nâ€¢ ìœ ì €ì—ê²Œ 500Pê°€ ì§€ê¸‰ë©ë‹ˆë‹¤')) return;

      try {
        const result = await API.admin.approve(id);
        showToast(result.message || 'ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        await loadData();
      } catch (error) {
        showToast(error.message || 'ìŠ¹ì¸ ì‹¤íŒ¨', 'error');
      }
    }

    async function rejectReview(id) {
      const reason = document.getElementById(`reject-${id}`).value;
      if (!reason) {
        showToast('ë°˜ë ¤ ì‚¬ìœ ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
        return;
      }
      if (!confirm(`ì´ ì œë³´ë¥¼ ë°˜ë ¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì‚¬ìœ : ${reason}`)) return;

      try {
        const result = await API.admin.reject(id, reason);
        showToast(result.message || 'ë°˜ë ¤ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        await loadData();
      } catch (error) {
        showToast(error.message || 'ë°˜ë ¤ ì‹¤íŒ¨', 'error');
      }
    }

    function openImageModal(src) {
      document.getElementById('modal-image').src = src;
      document.getElementById('image-modal').classList.add('active');
    }

    function closeImageModal() {
      document.getElementById('image-modal').classList.remove('active');
    }

    // íƒ­ í´ë¦­
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', async () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        currentTab = tab.dataset.status;
        await loadData();
      });
    });

    // ESCë¡œ ëª¨ë‹¬ ë‹«ê¸°
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeImageModal();
    });

    // ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>